{% extends 'layouts/base.html' %}

{% block title %}{{ config.MAIN_TITLE|safe }}{% endblock %}
{% block meta_description %}{% endblock %}
{% block head %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/CoreUI-v1.0.6/style.css', _external=True) }}">

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/CoreUI-v1.0.6/simple-line-icons-2.4.1.css', _external=True) }}">

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/dynatables-0.3.1/jquery.dynatable.css', _external=True) }}">

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/bootstrap-switch-3.3.4/css/bootstrap3/bootstrap-switch.min.css', _external=True) }}">

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/bootstrap-hardskilled-extend-select-1.1.4/css/select.min.css', _external=True) }}">

    <link rel="stylesheet"
          href="{{ url_for('static', filename='vendor/icheck-1.x/skins/square/blue.css', _external=True) }}">

    <link rel="stylesheet"
          href="//use.fontawesome.com/releases/v5.0.2/css/all.css">

    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/css/fileinput.min.css"/>

    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/codemirror.css"/>

    <link rel="stylesheet"
          href="{{ url_for('static', filename='styles/main.css', _external=True) }}">

    <style>
        .CodeMirror {
            border: 1px solid #ddd;
            font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            height: 100px;
        }

        .results-wrapper {
            overflow-y: scroll;
            height: 200px;
        }

        .tab-content {
            border: none
        }

        .biojs_msa_header {
            white-space: nowrap;
            text-align: center;
        }

        .biojs_msa_labels {
            white-space: nowrap;
            text-align: right;
        }
    </style>

{% endblock %}

{% block body %}

<body>
    <div class="container-fluid">

        <div class="row">
            <div class="col-10">
                <div id="mafViewer"></div>
            </div>
        </div>


    </div>


</div>


</body>
{% endblock %}

{% block javascript %}

    <script src="//code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
            integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
            crossorigin="anonymous"></script>

    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
            integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
            crossorigin="anonymous"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.5/js/fileinput.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/codemirror.js"></script>

    <!-- D3 //-->
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/d3-queue.v3.min.js"></script>
    <script src="//d3js.org/d3-request.v1.min.js"></script>

    <!-- Extra //-->
    <script src="{{ url_for('static', filename='vendor/CoreUI-v1.0.6/app.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/dynatables-0.3.1/jquery.dynatable.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/bootstrap-hardskilled-extend-select-1.1.4/js/select.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/bootstrap-switch-3.3.4/js/bootstrap-switch.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/bootstrap-switch-3.3.4/js/bootstrap-switch.min.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/jquery-check-all-0.5.0/jquery-check-all.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/icheck-1.x/icheck.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/msa/dist/msa.js') }}"></script>

    <script>

    // Extended disable function
    jQuery.fn.extend({
        disable: function(state) {
            return this.each(function() {
                let $this = $(this);
                if($this.is('input, button, textarea, select'))
                    this.disabled = state;
                else
                    $this.toggleClass('disabled', state);
            });
        }
    });

    /**
     * Download data.
     * @param {string} URL - the URL to download data
     * @param {string} description - descriptive text
     * @param {function} callback - the callback function
     */
    function downloadData(URL, description, callback) {
        /*
         From d3.js documentation:

         When a task completes, it must call the provided callback.

         The first argument to the callback should be null if the task is successful,
         or the error if the task failed.

         The optional second argument to the callback is the return value of the task.
         (To return multiple values from a single callback, wrap the results in an object or array.)
         */
        console.log('Downloading: ', URL);

        $.ajax({
            url: URL,
            method: 'GET'
        }).done(function(data, textStatus, jqXHR) {
            console.log(`Download of ${description}:`, data);
            callback(null, data);
        }).fail(function(jqXHR, textStatus, errorThrown) {
            //displayError('Server Error', 'Unable to download ' + description);
            console.error(description, textStatus);
            callback(errorThrown, null);
        });
    }

    var globals = {};

    function setStatus(done) {
        $('#textarea-to').disable(!done);
        $('#convert-to').disable(!done);

        $('#input-id').parent().disable(!done);
        $('#btnConvert').disable(!done);
        $('#btnDownload').disable(!done);

        $('.select-extended-element .btn').disable(!done);

        if (done) {
            globals.inputFrom.setOption('readOnly', false);
            $('#btnConvert').html('Convert <i class="fas fa-exchange-alt">');
        } else {
            globals.inputFrom.setOption('readOnly', 'nocursor');
            $('#btnConvert').html('Convert <i class="fa fa-cog fa-spin fa-fw"></i>');
            $('#conversionStatus').html('Performing conversion...');
            $('#conversionErrors').html('');
        }
    }

    function downloadProteins() {
        let searchVals = $("#searchTerm").val().trim().split('\n');
        let exactMatch = $("#exactMatch").is(":checked");

        for (let s in searchVals) {
            if (!exactMatch) {
                searchVals[s] = "*" + searchVals[s].trim() + "*"
            }
        }

     // send ajax POST request to start background job
        console.log(searchVals);
        $.ajax({
            type: 'POST',
            url: `{{ url_for('api.search', _external=True) }}`,
            contentType: 'application/json',
            data: JSON.stringify({'sequences': searchVals}),
            success: function(data, status, request) {
                let status_url = request.getResponseHeader('Location');
                console.log('status_url=', status_url);
            },
            error: function() {
                alert('Unexpected error');
            }
        });
    }


    function displayProteins(result) {
        //console.log('displaying', result);
        let t = $('#tblBody');
        $.each(result, function(seq_idx, seq_elem) {
            //console.log(seq_elem);

            if (seq_elem.length == 0) {
                let r = '<tr><td colspan="12">' + seq_idx + '</td></tr>';
                t.append(r);
            } else {

                $.each(seq_elem, function (gene_idx, gene_elem) {
                    //console.log(gene_elem);

                    $.each(gene_elem.proteins, function (protein_idx, protein_elem) {
                        //console.log(protein_elem)

                        let r = '<tr><td>' + seq_idx + '</td>';
                        r += ('<td>' + gene_elem.ensembl_id + '</td>');
                        r += ('<td>' + gene_elem.symbol + '</td>');
                        r += ('<td>' + protein_idx + '</td>');
                        let count = 0;

                        {% for strain in config.STRAINS %}
                        if (protein_elem['{{strain.key}}'] > 0) {
                            {% if strain.key != 'B' %}
                            count++;
                            {% endif %}
                            r += '<td class="text-center" ><span class="border badge" style="background-color:{{strain.color}}">{{strain.key}}</span></td>';
                        } else {
                            r += '<td class="text-center"></td>';
                        }
                        {% endfor %}

                        r += '</tr>';

                        if (count > 0) {
                            t.append(r);
                        }


                    });

                });
            }
        });



        $("#searchProgressDiv").removeClass("visible");
        $("#searchProgressDiv").addClass("invisible");
        $("#searchProgress").css("width", "0%");
        $("#btnGo").attr("running", "0");
        $("#btnGo").button().removeClass("disabled");

    }



    function findProteins() {
        let searchVal = $("#searchTerm").val().trim().toUpperCase();

        let running = $("#btnGo").attr("running");
        $("#searchProgressDiv").removeClass("invisible");
        $("#searchProgressDiv").addClass("visible");
        $("#searchProgress").css("width", "0%");

        if (running === "1") {
            console.log('preventing click...');
            return;
        }

        $("#btnGo").attr("running", "1");
        $("#btnGo").button().addClass("disabled");

        $("#tblBody").html('');

        if (searchVal.length === 0) {
            return;
        }

        downloadProteins();
    }

    function setStatus(done) {

        $('#btnGeneSearch').disable(!done);
        $('#txtGeneSearch').disable(!done);

        if (done) {
            $('#btnGeneSearch').html('<i class="fas fa-search">');
        } else {
            $('#btnGeneSearch').html('<i class="fa fa-cog fa-spin fa-fw"></i>');
        }
    }

       function updateMSAData(taskID) {
            // send GET request to status URL
            console.log('updateMSAData');
            console.log(taskID);

            if (globals.runningTask) {
                let statusURL = '{{ url_for('api.clustalo_status', task_id='', _external=True) }}' + taskID;
                $.ajax({
                    type: 'GET',
                    url: statusURL,
                    success: function (data, status, request) {
                        console.log('DATA=======', data);
                        if (data['status'] === 'DONE') {
                            if ('error' in data) {
                                // MAJOR ERROR
                                let message = `Unfortunately, there was a problem contacting the server.  Please try again.`;
                                stopTask();
                                console.log('ERROR');
                            } else {
                                    displayMSAViewer(taskID);
                                    stopTask();
                            }
                        } else {
                            // rerun in 1 seconds
                            console.log('Not done, keep checking...');
                            setTimeout(function () {
                                updateMSAData(taskID);
                            }, 1000);  // TODO: change to 1000 (1 second)
                        }
                    }
                });
            } else {
            }
        }

        function startTask() {
        globals.runningTask = true;
        }

        function stopTask() {
        globals.runningTask = false;
        }

    function generateMSAData(ensemblID) {

        startTask();



        $.ajax({
            type: 'POST',
            url: "{{ url_for('api.clustalo_gene', _external=True) }}",
            data: {'ensemblID': ensemblID},
            success: function(data, status, request) {
                console.log('data=', data);
                console.log('status=', status);
                console.log('request=', request);
                updateMSAData(data.task_id);
            },
            error: function(a, b, c) {
                // TODO: handle
                console.log(a,b,c);
                alert('Unexpected error');
            }
        });

    }

    function displayMSAViewer(task_id) {
        let h = `
            <div class="row" id="generatedMAFDIV">
                <div class="col">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i> Viewer</a>
                        </div>
                        <div class="card-body">
                            <div id="mafDIV"></div>
                        </div>
                    </div>
                </div>
            </div>`;


        $('#mafSpacer').after(h);

        console.log('task_id=', task_id);
		        let opts = {};

		        // set your custom properties
		        // @see: https://github.com/wilzbach/biojs-vis-msa/tree/master/src/g
		        opts.el = document.getElementById("mafDIV");
		        opts.vis = {
					sequences: true,
					markers: true,
					metacell: false,
					conserv: false,
					overviewbox: true,
					seqlogo: false,
					gapHeader: true,
					leftHeader: true,

					// about the labels
					labels: true,
					labelName: true,
					labelId: false, // default is true
					labelPartition: false,
					labelCheckbox: false,

					// meta stuff
					metaGaps: true,
					metaIdentity: true,
					metaLinks: true
		        };
		        opts.conf = {
					registerMouseHover: false,
					registerMouseClicks: true,
					importProxy: "http://", // default is "https://cors-anywhere.herokuapp.com/",
					eventBus: true,
					alphabetSize: 20,
					dropImport: false,
					debug: true,
					hasRef: false, // hasReference,
					manualRendering: false // manually control the render (not recommened)
				};
				opts.menu = {
					menuFontsize: "14px",
					menuItemFontsize: "14px",
					menuItemLineHeight: "14px",
					menuMarginLeft: "3px",
					menuPadding: "3px 4px 3px 4px",
				};



		        opts.zoomer = {
					// general
					alignmentWidth: "auto",
					alignmentHeight: 225,
					columnWidth: 15,
					rowHeight: 15,
					autoResize: true, // only for the width

					// labels
					textVisible: true,
					labelIdLength: 30,
					labelNameLength: 200, // 100
					labelPartLength: 15,
					labelCheckLength: 15,
					labelFontsize: 13,
					labelLineHeight: "13px",

					// marker
					markerFontsize: "10px",
					stepSize: 1,
					markerStepSize: 2,
					markerHeight: 20,

					// canvas
					residueFont: "13", //in px
					canvasEventScale: 1,

					// overview box
					boxRectHeight: 2,
					boxRectWidth: 2,
					overviewboxPaddingTop: 10,

					// meta cell
					metaGapWidth: 35,
					metaIdentWidth: 40,
					metaLinksWidth: 25

		        };

		        // init msa
		        var m = new msa(opts);

				let url = '{{ url_for('api.clustalo_data', _external=True) }}?task_id=' + task_id;
				console.log('URL=', url);
		        m.u.file.importURL(url, renderMSA);

		        function renderMSA() {

		            // the menu is independent to the MSA container
		            var menuOpts = {};
		            menuOpts.el = document.getElementById('div');
		            menuOpts.msa = m;
		            //menuOpts.menu = "small";
		            var defMenu = new msa.menu.defaultmenu(menuOpts);
		            m.addView("menu", defMenu);

		            // call render at the end to display the whole MSA
		            m.render();


		        }


    }

    /**
     * Populate the search results.
     */
    function geneSearchCallback(error, data) {
        if (data.length === 0) {
            setStatus(true);
            $('#geneSearchResultsStatus').html('No results found');
            return;
        }

        let divResults = `
            <div class="row" id="generatedSearchResultsDIV">
                <div class="col">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-chart-line"></i> Search Results</a>
                        </div>
                        <div class="card-body">
                            <div class="results-wrapper">
                                <table id="geneSearchResultsTable" class="table table-striped table-hover table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th class="" scope="col">Gene</th>
                                        <th class="" scope="col">Symbol</th>
                                        {% for strain in config.STRAINS %}
                                            <th class="text-center"><span class="border badge" style="background-color:{{strain.color}}">{{strain.key}}</span></th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody id="geneTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;


        $('#searchSpacer').after(divResults);

        let t = $('#geneTableBody');


        /*
        $.each(data, function(seq_idx, seq_elem) {
            console.log(seq_elem);

            if (seq_elem.length == 0) {
                let r = '<tr><td colspan="12">' + seq_idx + '</td></tr>';
                t.append(r);
            } else {

                $.each(seq_elem, function (gene_idx, gene_elem) {
                    //console.log(gene_elem);

                    $.each(gene_elem.proteins, function (protein_idx, protein_elem) {
                        //console.log(protein_elem)

                        let r = '<tr><td>' + seq_idx + '</td>';
                        r += ('<td>' + gene_elem.ensembl_id + '</td>');
                        r += ('<td>' + gene_elem.symbol + '</td>');
                        r += ('<td>' + protein_idx + '</td>');
                        let count = 0;

                        {% for strain in config.STRAINS %}
                        if (protein_elem['{{strain.key}}'] > 0) {
                            {% if strain.key != 'B' %}
                            count++;
                            {% endif %}
                            r += '<td class="text-center" ><span class="border badge" style="background-color:{{strain.color}}">{{strain.key}}</span></td>';
                        } else {
                            r += '<td class="text-center"></td>';
                        }
                        {% endfor %}

                        r += '</tr>';

                        if (count > 0) {
                            t.append(r);
                        }


                    });

                });
            }
        });

        */




        $.each(data, function (gene_idx, gene_elem) {
            //console.log(gene_elem);

            let r = '<tr><td><a href="#" geneID="' + gene_elem.ensembl_id + '">' + gene_elem.ensembl_id + '</a></td>';
            r += ('<td>' + gene_elem.symbol + '</td>');


            {% for strain in config.STRAINS %}
                if ('{{strain.key}}' in gene_elem.strains) {
                    r += ('<td class="text-center">' + gene_elem.strains['{{strain.key}}'].count + '</td>');
                } else {
                    r += ('<td class="text-center">0</td>')
                }
            {% endfor %}

            r += '</tr>';

            t.append(r);
        });



        $('#geneTableBody a').on('click', function(evt) {
            evt.preventDefault();
            let that = $(this);
            generateMSAData(that.attr('geneid'));
            return false;
        });


        setStatus(true);
    }

    function findGene(searchVal) {
        let term = $('#txtGeneSearch');

        if (searchVal.length === 0) {
            term.focus();
            return;
        }

        setStatus(false);
        let url = `{{ url_for('api.gene', gene_id='', _external=True) }}${searchVal}`;
        downloadData(url, 'genes', geneSearchCallback);
    }

    $().ready(function () {
        globals.searchTerms = CodeMirror.fromTextArea($('#textarea-proteins')[0], {
            lineNumbers: true,
            viewportMargin: 3
        });

        $('input').iCheck({
            checkboxClass: 'icheckbox_square-blue',
            radioClass: 'iradio_square-blue',
            increaseArea: '20%' // optional
        });


        $('#txtGeneSearch').keypress(function(evt) {
            let code = evt.which ? evt.which : evt.keyCode;
            if (code === 13) {
                $(this).blur();
                $('#btnGeneSearch').focus().click();
            }
        });

        $('#btnGeneSearch').button().on('click', function(evt) {
            evt.preventDefault();
            let term = $('#txtGeneSearch');
            findGene(term.val().trim());
            return false;
        });

        $('#btnGo').button().on('click', function (evt) {
            evt.preventDefault();
            console.log('findProteins');
            findProteins();
            return false;
        });
    });
    //-->

    </script>


{% if not config.DEBUG %}
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-113547780-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-113547780-1');
</script>
{% endif %}


{% endblock %}
